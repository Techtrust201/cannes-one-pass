// Prisma schema pour "palais_des_festivals"
// Inclut les modèles Better Auth + modèles métier existants

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS - Authentification & Permissions
// ============================================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
}

enum Feature {
  LISTE
  CREER
  PLAQUE
  QR_CODE
  FLUX_VEHICULES
  BILAN_CARBONE
  GESTION_ZONES
  GESTION_DATES
  ARCHIVES
}

// ============================================================
// ENUMS - Métier (existants)
// ============================================================

enum AccreditationStatus {
  ATTENTE
  ENTREE
  SORTIE
  NOUVEAU
  REFUS
  ABSENT
}

enum HistoryAction {
  CREATED
  STATUS_CHANGED
  VEHICLE_ADDED
  VEHICLE_REMOVED
  VEHICLE_UPDATED
  EMAIL_SENT
  INFO_UPDATED
  DELETED
  ZONE_CHANGED
  ZONE_TRANSFER
  VEHICLE_RETURN
  ARCHIVED
  CHAT_MESSAGE
}

enum VehicleType {
  PORTEUR
  PORTEUR_ARTICULE
  SEMI_REMORQUE
}

// enum Zone — SUPPRIMÉ : les zones sont maintenant dynamiques (String + ZoneConfig)
// Les anciennes valeurs LA_BOCCA, PALAIS_DES_FESTIVALS, PANTIERO, MACE sont
// maintenues comme données dans la table ZoneConfig.

enum ZoneAction {
  ENTRY
  EXIT
  TRANSFER
}

enum CountryRegion {
  FRANCE
  ESPAGNE
  ITALIE
  ALLEMAGNE
  BELGIQUE
  SUISSE
  ROYAUME_UNI
  PAYS_BAS
  PORTUGAL
  AUTRE
}

// ============================================================
// MODÈLES Better Auth
// ============================================================

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Champs custom pour gestion des rôles et permissions
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true)

  // Relations Better Auth
  sessions      Session[]
  accounts      Account[]

  // Relations custom
  permissions   UserPermission[]
  chatMessages  ChatMessage[]

  @@map("user")
}

model Session {
  id        String   @id @default(uuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id @default(uuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

// ============================================================
// MODÈLE CUSTOM - Permissions granulaires
// ============================================================

model UserPermission {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  feature   Feature
  canRead   Boolean  @default(false)
  canWrite  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([userId, feature])
  @@map("user_permission")
}

// ============================================================
// MODÈLES MÉTIER (existants)
// ============================================================

model Event {
  id                String    @id @default(uuid())
  name              String
  slug              String    @unique
  logo              String?
  description       String?   @db.Text
  location          String?
  color             String    @default("#3DAAA4")

  startDate         DateTime
  endDate           DateTime

  setupStartDate    DateTime?
  setupEndDate      DateTime?
  teardownStartDate DateTime?
  teardownEndDate   DateTime?

  accessStartTime   String?
  accessEndTime     String?

  notes             String?   @db.Text

  activationDays    Int       @default(7)
  isActive          Boolean   @default(false)
  isArchived        Boolean   @default(false)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  accreditations    Accreditation[]

  @@index([isArchived, startDate])
}

model Accreditation {
  id          String               @id @default(uuid())
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  version     Int                  @default(0)
  company     String
  stand       String
  unloading   String
  event       String
  eventId     String?
  eventRef    Event?               @relation(fields: [eventId], references: [id])
  message     String?
  consent     Boolean              @default(false)
  status      AccreditationStatus  @default(ATTENTE)
  entryAt     DateTime?
  exitAt      DateTime?
  email       String?              @db.VarChar(255)
  sentAt      DateTime?
  currentZone String?

  isArchived  Boolean              @default(false)

  vehicles       Vehicle[]
  emailHistory   AccreditationEmailHistory[]
  history        AccreditationHistory[]
  zoneMovements  ZoneMovement[]
  timeSlots      VehicleTimeSlot[]
  chatMessages   ChatMessage[]

  @@index([eventId])
}

model Vehicle {
  id              Int          @id @default(autoincrement())
  plate           String
  size            String
  phoneCode       String
  phoneNumber     String
  date            String
  time            String
  city            String
  unloading       String       @db.Text
  kms             String?
  
  // Nouveaux champs pour le bilan carbone
  vehicleType     VehicleType?
  country         CountryRegion?
  estimatedKms    Int          @default(0)
  arrivalDate     DateTime?
  departureDate   DateTime?

  // Plaque de la remorque (semi-remorque uniquement, facultatif)
  trailerPlate    String?

  // Champs poids (en tonnes)
  emptyWeight     Int?
  maxWeight       Int?
  currentWeight   Int?

  accreditation   Accreditation @relation(fields: [accreditationId], references: [id], onDelete: Cascade)
  accreditationId String

  timeSlots       VehicleTimeSlot[]
}

model ZoneMovement {
  id              Int           @id @default(autoincrement())
  accreditation   Accreditation @relation(fields: [accreditationId], references: [id], onDelete: Cascade)
  accreditationId String
  fromZone        String?
  toZone          String
  action          ZoneAction
  timestamp       DateTime      @default(now())
  userId          String?
  userAgent       String?
}

model AccreditationEmailHistory {
  id              Int           @id @default(autoincrement())
  accreditation   Accreditation @relation(fields: [accreditationId], references: [id], onDelete: Cascade)
  accreditationId String
  email           String
  sentAt          DateTime      @default(now())
}

model AccreditationHistory {
  id              Int             @id @default(autoincrement())
  accreditation   Accreditation   @relation(fields: [accreditationId], references: [id], onDelete: Cascade)
  accreditationId String
  action          HistoryAction
  field           String?         // Champ modifié (ex: "status", "company", etc.)
  oldValue        String?         // Ancienne valeur
  newValue        String?         // Nouvelle valeur
  description     String          // Description lisible de l'action
  userId          String?         // ID de l'utilisateur qui a fait la modification
  userAgent       String?         // User agent pour tracer l'origine
  createdAt       DateTime        @default(now())

  @@index([createdAt])                    // Accélère le polling /changes et l'archivage
  @@index([accreditationId, createdAt])   // Accélère la lecture d'historique par accréditation
}

// ============================================================
// TABLE D'ARCHIVE — Historique compressé (> 13 mois)
// ============================================================

model AccreditationHistoryArchive {
  id              Int           @id           // Même ID que l'original
  accreditationId String
  action          HistoryAction
  summary         String        // JSON compact : {"f":"status","o":"ATTENTE","n":"ENTREE","d":"Statut…","u":"userId"}
  createdAt       DateTime      // Date de l'action originale
  archivedAt      DateTime      @default(now())

  @@index([accreditationId])
  @@index([createdAt])
}

// ============================================================
// CRÉNEAUX HORAIRES — Suivi entrées/sorties par étape (retour véhicule)
// ============================================================

model VehicleTimeSlot {
  id              Int           @id @default(autoincrement())
  accreditation   Accreditation @relation(fields: [accreditationId], references: [id], onDelete: Cascade)
  accreditationId String
  vehicle         Vehicle       @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId       Int
  date            DateTime      @db.Date       // Jour du créneau
  stepNumber      Int                          // Numéro d'étape dans la journée (1, 2, 3…)
  zone            String                       // Zone d'entrée/sortie (clé dynamique vers ZoneConfig)
  entryAt         DateTime                     // Heure d'entrée
  exitAt          DateTime?                    // Heure de sortie (null = encore sur place)

  @@index([accreditationId, date])
  @@index([vehicleId, date])
}

// ============================================================
// CHAT — Messages inter-agents sur une accréditation
// ============================================================

model ChatMessage {
  id              Int           @id @default(autoincrement())
  accreditation   Accreditation @relation(fields: [accreditationId], references: [id], onDelete: Cascade)
  accreditationId String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String        // ID de l'agent qui envoie le message
  userName        String        // Nom de l'agent (dénormalisé pour perf)
  message         String        @db.Text
  createdAt       DateTime      @default(now())

  @@index([accreditationId, createdAt])
}

// ============================================================
// CONFIGURATION DES ZONES — Adresses et coordonnées GPS
// ============================================================

model ZoneConfig {
  id                 Int      @id @default(autoincrement())
  zone               String   @unique              // Identifiant unique de la zone (ex: "LA_BOCCA")
  label              String                        // Nom d'affichage (ex: "La Bocca")
  address            String                        // Adresse complète
  latitude           Float                         // Latitude GPS
  longitude          Float                         // Longitude GPS
  isFinalDestination Boolean  @default(false)      // Destination finale (Palais)
  color              String   @default("gray")     // Couleur associée (ex: "orange", "green", "blue", "purple")
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}
