// Prisma schema pour "palais_des_festivals"
// Inclut les modèles Better Auth + modèles métier existants

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS - Authentification & Permissions
// ============================================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
}

enum Feature {
  LISTE
  CREER
  PLAQUE
  QR_CODE
  FLUX_VEHICULES
  BILAN_CARBONE
  GESTION_ZONES
  GESTION_DATES
}

// ============================================================
// ENUMS - Métier (existants)
// ============================================================

enum AccreditationStatus {
  ATTENTE
  ENTREE
  SORTIE
  NOUVEAU
  REFUS
  ABSENT
}

enum HistoryAction {
  CREATED
  STATUS_CHANGED
  VEHICLE_ADDED
  VEHICLE_REMOVED
  VEHICLE_UPDATED
  EMAIL_SENT
  INFO_UPDATED
  DELETED
  ZONE_CHANGED
  ZONE_TRANSFER
}

enum VehicleType {
  PORTEUR
  PORTEUR_ARTICULE
  SEMI_REMORQUE
}

enum Zone {
  LA_BOCCA
  PALAIS_DES_FESTIVALS
  PANTIERO
  MACE
}

enum ZoneAction {
  ENTRY
  EXIT
  TRANSFER
}

enum CountryRegion {
  FRANCE
  ESPAGNE
  ITALIE
  ALLEMAGNE
  BELGIQUE
  SUISSE
  ROYAUME_UNI
  PAYS_BAS
  PORTUGAL
  AUTRE
}

// ============================================================
// MODÈLES Better Auth
// ============================================================

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Champs custom pour gestion des rôles et permissions
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true)

  // Relations Better Auth
  sessions      Session[]
  accounts      Account[]

  // Relations custom
  permissions   UserPermission[]

  @@map("user")
}

model Session {
  id        String   @id @default(uuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id @default(uuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

// ============================================================
// MODÈLE CUSTOM - Permissions granulaires
// ============================================================

model UserPermission {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  feature   Feature
  canRead   Boolean  @default(false)
  canWrite  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([userId, feature])
  @@map("user_permission")
}

// ============================================================
// MODÈLES MÉTIER (existants)
// ============================================================

model Accreditation {
  id          String               @id @default(uuid())
  createdAt   DateTime             @default(now())
  company     String
  stand       String
  unloading   String
  event       String
  message     String?
  consent     Boolean              @default(false)
  status      AccreditationStatus  @default(ATTENTE)
  entryAt     DateTime?
  exitAt      DateTime?
  email       String?              @db.VarChar(255)
  sentAt      DateTime?
  currentZone Zone?

  vehicles       Vehicle[]
  emailHistory   AccreditationEmailHistory[]
  history        AccreditationHistory[]
  zoneMovements  ZoneMovement[]
}

model Vehicle {
  id              Int          @id @default(autoincrement())
  plate           String
  size            String
  phoneCode       String
  phoneNumber     String
  date            String
  time            String
  city            String
  unloading       String       @db.Text
  kms             String?
  
  // Nouveaux champs pour le bilan carbone
  vehicleType     VehicleType?
  country         CountryRegion?
  estimatedKms    Int          @default(0)
  arrivalDate     DateTime?
  departureDate   DateTime?

  // Champs poids (en tonnes)
  emptyWeight     Int?
  maxWeight       Int?
  currentWeight   Int?

  accreditation   Accreditation @relation(fields: [accreditationId], references: [id], onDelete: Cascade)
  accreditationId String
}

model ZoneMovement {
  id              Int           @id @default(autoincrement())
  accreditation   Accreditation @relation(fields: [accreditationId], references: [id], onDelete: Cascade)
  accreditationId String
  fromZone        Zone?
  toZone          Zone
  action          ZoneAction
  timestamp       DateTime      @default(now())
  userId          String?
  userAgent       String?
}

model AccreditationEmailHistory {
  id              Int           @id @default(autoincrement())
  accreditation   Accreditation @relation(fields: [accreditationId], references: [id], onDelete: Cascade)
  accreditationId String
  email           String
  sentAt          DateTime      @default(now())
}

model AccreditationHistory {
  id              Int             @id @default(autoincrement())
  accreditation   Accreditation   @relation(fields: [accreditationId], references: [id], onDelete: Cascade)
  accreditationId String
  action          HistoryAction
  field           String?         // Champ modifié (ex: "status", "company", etc.)
  oldValue        String?         // Ancienne valeur
  newValue        String?         // Nouvelle valeur
  description     String          // Description lisible de l'action
  userId          String?         // ID de l'utilisateur qui a fait la modification
  userAgent       String?         // User agent pour tracer l'origine
  createdAt       DateTime        @default(now())
}
